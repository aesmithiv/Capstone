<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agreed. - Person to person loans made simple</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    

    <style>
        html, body {
          margin: 0;
          padding: 0;
          height: 100%;
          font-family: 'Courier New', monospace;
          background-color: #fff;
          overflow: hidden; /* lock global scroll, enable only container scroll */
        }
      
        .navbar {
          position: sticky;
          top: 0;
          width: 100%;
          background: black;
          color: white;
          display: flex;
          justify-content: space-between;
          padding: 15px 20px;
          font-size: 18px;
          z-index: 1000;
        }
      
        .container {
  padding: 100px 20px 40px; /* ensures space below sticky navbar and above bottom buttons */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center; /* 👈 centers content vertically */
  min-height: calc(100vh - 140px); /* ensures it's not too tall or too short */
  box-sizing: border-box;
  animation: fadeIn 0.5s ease-in-out;
  text-align: center;
}

.container.accounts-page {
  padding: 100px 20px 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  height: calc(100vh - 100px); /* Adjusts for sticky navbar */
  overflow-y: auto; /* Enables scrolling */
  box-sizing: border-box;
  animation: fadeIn 0.5s ease-in-out;
  text-align: center;
}

.accounts-page {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 100px;
  height: 100vh;
  box-sizing: border-box;
}

.scroll-area {
  flex: 1;
  overflow-y: auto;
  width: 100%;
  padding: 0 20px;
  box-sizing: border-box;
}

.account-buttons {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 20px 0;
  flex-wrap: wrap;
}





      
        /* === NO CHANGES NEEDED BELOW THIS LINE (continue using your existing styles) === */
      
        .nav-links {
          position: relative;
          display: inline-block;
        }
      
        .nav-button {
          background: black;
          color: white;
          border: none;
          padding: 10px;
          cursor: pointer;
        }
      
        .nav-button:hover {
          background: grey;
        }
      
        .dropdown-menu {
          display: none;
          position: absolute;
          right: 0;
          background: white;
          color: black;
          min-width: 200px;
          box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
          z-index: 1000;
        }
      
        .dropdown-menu a {
          display: block;
          padding: 10px;
          text-decoration: none;
          color: black;
        }
      
        .dropdown-menu a:hover {
          background: lightgrey;
        }
      
        .nav-links:hover .dropdown-menu {
          display: block;
        }
      
        .btn-custom {
          background-color: black;
          color: white;
          border-radius: 5px;
          padding: 10px 20px;
          border: none;
          margin-top: 20px;
          transition: background-color 0.3s ease-in-out, transform 0.2s;
        }
      
        .btn-custom:hover {
          background-color: grey;
          transform: scale(1.05);
        }
      
        .btn-group {
          display: flex;
          gap: 20px;
          margin-top: 20px;
        }
      
        .form-container {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
          margin-top: 20px;
          width: 80%;
          max-width: 350px;
          text-align: left;
        }
      
        .form-control {
          width: 100%;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 5px;
          margin-top: 10px;
        }
      
        .form-control::placeholder {
          color: black;
          opacity: 0.5;
        }
      
        .form-label {
          font-weight: bold;
          margin-top: 10px;
        }
      
        .repayment-options {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
          margin-top: 20px;
        }
      
        .top-right-buttons {
          position: absolute;
          top: 20px;
          right: 20px;
          display: flex;
          gap: 10px;
        }
      
        .pdf-button,
        .print-button {
          background: black;
          color: white;
          padding: 10px 15px;
          border-radius: 5px;
          border: none;
          cursor: pointer;
        }
      
        .pdf-button:hover,
        .print-button:hover {
          background: grey;
        }
      
        .back-button-bottom {
          position: fixed;
          bottom: 20px;
          left: 20px;
          display: block;
          width: 100%;
          max-width: 200px;
          margin: 30px auto;
          background: black;
          color: white;
          padding: 10px 15px;
          border-radius: 5px;
          border: none;
          cursor: pointer;
          text-align: center;
        }
      
        .back-button-bottom:hover {
          background: grey;
        }
      
        .bottom-nav {
          text-align: center;
          margin-top: 30px;
        }
      
        .signature-section {
          display: flex;
          justify-content: space-between;
          align-items: center;
          width: 100%;
          margin-top: 20px;
        }
      
        .signature-box {
          display: flex;
          flex-direction: column;
          align-items: center;
          width: 45%;
          border: 2px solid black;
          padding: 10px;
          border-radius: 5px;
          background-color: white;
          animation: fadeIn 0.5s ease-in-out;
        }
      
        .signature-canvas {
          border: 2px solid black;
          width: 100%;
          height: 150px;
          display: none;
          touch-action: none;
        }
      
        .signature-img {
          width: 100%;
          max-height: 100px;
          display: none;
        }
      
        .signature-button {
          padding: 8px 12px;
          font-size: 14px;
          cursor: pointer;
          background-color: black;
          color: white;
          border-radius: 5px;
          border: none;
          margin-top: 10px;
        }
      
        .signature-button:hover {
          background-color: grey;
        }
      
        .clear-btn,
        .save-btn {
          background-color: black;
          display: none;
        }
      
        .clear-btn:hover,
        .save-btn:hover {
          background-color: grey;
        }
      
        @media print {
          body {
            zoom: 0.85;
          }
      
          .top-right-buttons,
          .bottom-nav,
          .navbar,
          button[onclick="goToAccountPage()"],
          button[onclick="saveContractToAccount()"] {
            display: none !important;
          }
      
          .signature-section {
            page-break-inside: avoid;
            break-inside: avoid;
            margin-top: 20px;
          }
      
          .signature-box img {
            max-height: 50px !important;
            max-width: 75px !important;
          }
      
          #savedContractText,
          #contractText {
            text-align: center;
            margin: 0 auto;
            background: #f1f1f1;
            padding: 20px;
            border-radius: 10px;
            white-space: pre-wrap;
            max-width: 700px;
            font-size: 14px;
          }
        }
      
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(-10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
      
        .input-group {
          display: flex;
          align-items: center;
        }
      
        .input-group span {
          background: black;
          color: white;
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 5px 0 0 5px;
        }
      
        .input-group input {
          border-radius: 0 5px 5px 0;
          flex: 1;
        }
      
        input[type="checkbox"] {
          appearance: none;
          -webkit-appearance: none;
          width: 16px;
          height: 16px;
          border: 2px solid black;
          border-radius: 3px;
          cursor: pointer;
          position: relative;
        }
      
        input[type="checkbox"]:checked {
          background-color: black;
        }
      
        input[type="checkbox"]::before {
          content: "";
          position: absolute;
          top: 2px;
          left: 5px;
          width: 3px;
          height: 8px;
          border: solid white;
          border-width: 0 2px 2px 0;
          transform: rotate(45deg);
          display: none;
        }
      
        input[type="checkbox"]:checked::before {
          display: block;
        }
      
        .contract-cards {
          width: 100%;
        }
      
        .contract-card {
          border: 2px solid black;
          border-radius: 5px;
          margin-bottom: 15px;
          overflow: hidden;
        }
      
        .card-header {
          background-color: black;
          color: white;
          padding: 15px;
          cursor: pointer;
        }
      
        .card-header:hover {
          background-color: grey;
        }
      
        .card-body {
          background-color: #f9f9f9;
          padding: 15px;
          display: none;
        }
      </style>
      
      

    <script>
    let loanData = {};
    let signaturePads = {};
    let currentUser = null;
    let userContracts = {};
    let archivedContracts = {};
    let currentContractIndex = 0;



    function getNavbarHTML(isLandingPage = false) {
    let dropdownHTML = "";

    if (!isLandingPage) {
        if (currentUser) {
            dropdownHTML = `
                <div class="nav-links">
                    <button class="nav-button">${currentUser.username} ▼</button>
                    <div class="dropdown-menu">
                        <div style="padding: 10px; font-weight: bold;">
                            ${currentUser.firstName || ""} ${currentUser.lastName || ""}
                        </div>
                        <div style="padding: 10px;">Email: ${currentUser.email || ""}</div>
                        <div style="padding: 10px;">Phone: ${currentUser.phone || ""}</div>
                        <div style="padding: 10px;">Address: ${currentUser.address || ""}</div>
                        <a href="#" onclick="goToUserInfoPage()">Edit Info</a>
                        <a href="#" onclick="viewArchivedContracts()">Archived Contracts</a>
                        <a href="#" onclick="logout()">Logout</a>
                    </div>
                </div>`;
        } else {
            dropdownHTML = `
                <div class="nav-links">
                    <button class="nav-button">Loan Details ▼</button>
                    <div class="dropdown-menu">
                        <a href="#" onclick="goToRoleSelection()">👥 Role Selection</a>
                        <a href="#" onclick="goToEmailPage()">📧 Email</a>
                        <a href="#" onclick="goToUserInfoPage()">📝 Personal Info</a>
                        <a href="#" onclick="goToLoanAmountPage()">💰 Loan Amount</a>
                        <a href="#" onclick="goToRepaymentSchedulePage()">📆 Repayment Schedule</a>
                        <a href="#" onclick="goToStartDatePage()">📅 Start Date</a>
                    </div>
                </div>`;
        }
    }

    return `
        <nav class="navbar">
            <div class="nav-title">
                <a href="#" onclick="goToLandingPage()" style="color: white; text-decoration: none; font-weight: bold;">Agreed.</a>
            </div>
            ${dropdownHTML}
        </nav>`;
}






function goToLandingPage() {
    window.location.hash = "#landing";
    document.body.innerHTML = getNavbarHTML(true) + `
        <div class="container">
            <h1>Agreed.</h1>
            <p>Person to person loans made simple</p>
            <button class="btn btn-custom" onclick="goToAuthPage()">Continue</button>
        </div>
    `;

    // Allow Enter to trigger goToAuthPage
    document.addEventListener("keydown", function handler(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            goToAuthPage();
            document.removeEventListener("keydown", handler);
        }
    });
}

function goToAuthPage() {
    document.body.innerHTML = getNavbarHTML(true) + `
        <div class="container">
            <h2>Welcome</h2>
            <button class="btn btn-custom" onclick="handleLogin()">Login</button>
            <button class="btn btn-custom" onclick="handleSignup()">Sign Up</button>
            <hr style="width: 60%; margin: 20px auto;">
            <p>continue without an account:</p>
            <button class="btn btn-custom" onclick="continueAsGuest()">Continue as Guest</button>
        </div>
    `;
}

function handleLogin() {
    document.body.innerHTML = getNavbarHTML(true) + `
        <div class="container" style="max-width: 400px; width: 100%; margin-top: 50px;">
            <h2>Login</h2>
            <form id="loginForm" onsubmit="return false;" style="width: 100%;">
                <input type="text" id="loginUsername" class="form-control" placeholder="Username" autocomplete="username" required style="margin-top: 10px;">
                <input type="password" id="loginPassword" class="form-control" placeholder="Password" autocomplete="current-password" required style="margin-top: 10px;">
                <button type="submit" class="btn btn-custom" style="margin-top: 20px;">Login</button>
                <button type="button" class="btn btn-custom" onclick="goToAuthPage()">Back</button>
            </form>
        </div>
    `;

    // Wait for DOM to paint before attaching handler
    requestAnimationFrame(() => {
        const form = document.getElementById("loginForm");

        form.onsubmit = function (e) {
            e.preventDefault();
            submitLogin();
        };
    });
}

function submitLogin() {
    const username = document.getElementById("loginUsername").value;
    const password = document.getElementById("loginPassword").value;

    fetch("http://localhost:3000/user/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentUser = data.user;

                fetch(`http://localhost:3000/contracts/${currentUser.username}`)
                    .then(res => res.json())
                    .then(contracts => {
                        userContracts[currentUser.username] = contracts;
                        goToAccountPage();
                    });
            } else {
                alert(data.message || "Login failed.");
            }
        })
        .catch(err => {
            console.error("Login error:", err);
            alert("An error occurred while logging in.");
        });
}

function handleSignup() {
    document.body.innerHTML = getNavbarHTML(true) + `
        <div class="container">
            <h2>Create an Account</h2>
            <input type="text" id="signupUsername" class="form-control" placeholder="Username">
            <input type="password" id="signupPassword" class="form-control" placeholder="Password">
            <input type="email" id="signupEmail" class="form-control" placeholder="Email">
            <input type="text" id="signupFirstName" class="form-control" placeholder="First Name">
            <input type="text" id="signupLastName" class="form-control" placeholder="Last Name">
            <input type="tel" id="signupPhone" class="form-control" placeholder="Phone Number">
            <input type="text" id="signupAddress" class="form-control" placeholder="Address">
            <button class="btn btn-custom" onclick="submitSignup()">Sign Up</button>
            <button class="btn btn-custom" onclick="goToAuthPage()">Back</button>
        </div>
    `;

    // Add Enter key listener
    document.addEventListener("keydown", function handleSignupKey(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            submitSignup();
            document.removeEventListener("keydown", handleSignupKey);
        }
    });
}



function submitSignup() {
    const username = document.getElementById("signupUsername").value;
    const password = document.getElementById("signupPassword").value;
    const email = document.getElementById("signupEmail").value;
    const firstName = document.getElementById("signupFirstName").value;
    const lastName = document.getElementById("signupLastName").value;
    const phone = document.getElementById("signupPhone").value;
    const address = document.getElementById("signupAddress").value;

    const user = {
        username,
        password,
        email,
        firstName,
        lastName,
        phone,
        address
    };

    fetch("http://localhost:3000/user/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(user)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            currentUser = data.user; // we'll make sure backend sends full user
            fetch(`http://localhost:3000/contracts/${currentUser.username}`)
                .then(res => res.json())
                .then(contracts => {
                    userContracts[currentUser.username] = contracts;
                    goToAccountPage();
                });
        } else {
            alert(data.message || "Signup failed.");
        }
    });
}





function continueAsGuest() {
    currentUser = {
        username: "Guest",
        email: "",
        firstName: "",
        lastName: "",
        phone: "",
        address: ""
    };
    goToRoleSelection();
}


function goToAccountPage() {
    const contracts = userContracts[currentUser.username] || [];

    const contractsHTML = contracts.length === 0
        ? "<p>No saved contracts yet.</p>"
        : contracts.map((c, i) => {
            const paidCount = c.payments?.filter(p => p.paid).length || 0;
            const totalCount = c.payments?.length || 0;
            const progress = totalCount > 0 ? Math.round((paidCount / totalCount) * 100) : 0;

            const paymentList = (c.payments || []).map((pmt, idx) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${pmt.dueDate} - $${pmt.amount.toFixed(2)}</span>
                    <input type="checkbox" ${pmt.paid ? "checked" : ""} onchange="togglePaymentStatus('${i}', '${idx}')">
                </div>
            `).join("");

            return `
                <div style="border: 1px solid black; padding: 20px; margin-bottom: 20px; border-radius: 0; background-color: #f9f9f9;">
                    <h5 style="margin-bottom: 10px;">${c.displayName || `Contract ${i + 1}`} - ${c.date}</h5>
                    <div style="margin-bottom: 15px; display: flex; justify-content: center; gap: 10px;">
                        <button class="btn btn-custom" onclick="viewContract(${i})">View</button>
                        <button class="btn btn-custom" onclick="deleteContract(${i})">Delete</button>
                    </div>
                    <div>
                        <label style="font-weight: bold;">Progress:</label>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-dark" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="mt-2">${paidCount} of ${totalCount} payments received</p>
                        ${paymentList}
                        <div style="margin-top: 20px; display: flex; justify-content: center;">
                            <button class="btn btn-custom" onclick="markPaidInFull(${i})">Paid in Full</button>
                        </div>
                    </div>
                </div>
            `;
        }).join("");

    document.body.innerHTML = getNavbarHTML() + `
        <div class="container accounts-page">
            <div class="scroll-area">
                <h2>Welcome, ${currentUser.firstName || currentUser.username}</h2>
                <h4>Your Contracts</h4>
                ${contractsHTML}
            </div>
            <div class="account-buttons">
                <button class="btn btn-custom" onclick="startNewContract()">Create New Contract</button>
                <button class="btn btn-custom" onclick="logout()">Logout</button>
            </div>
        </div>
    `;
}


function prevContract() {
    if (currentContractIndex > 0) {
        currentContractIndex--;
        goToAccountPage();
    }
}

function nextContract() {
    const contracts = userContracts[currentUser.username] || [];
    if (currentContractIndex < contracts.length - 1) {
        currentContractIndex++;
        goToAccountPage();
    }
}


function saveTextAsPDFWithImages(index) {
    const jsPDF = window.jspdf?.jsPDF;
    if (!jsPDF) {
        alert("PDF library failed to load.");
        return;
    }

    const contract = userContracts[currentUser.username]
    [index];
    const doc = new jsPDF();
    const text = contract.content;

    doc.setFont("courier");
    doc.setFontSize(12);

    const marginLeft = 10;
    const marginTop = 10;
    const pageWidth = doc.internal.pageSize.getWidth() - 20;

    doc.text(text, marginLeft, marginTop, { maxWidth: pageWidth });

    const sigXLeft = marginLeft;
    const sigXRight = marginLeft + 100;
    const sigY = marginTop + 180;

    if (contract.lenderSignature) {
        doc.addImage(contract.lenderSignature, 'PNG', sigXLeft, sigY, 50, 25);
        doc.text("Lender Signature", sigXLeft + 10, sigY + 30);
    }

    if (contract.lenderQR) {
        doc.addImage(contract.lenderQR, 'PNG', sigXLeft, sigY + 40, 50, 50);
    }

    if (contract.borrowerSignature) {
        doc.addImage(contract.borrowerSignature, 'PNG', sigXRight, sigY, 50, 25);
        doc.text("Borrower Signature", sigXRight + 10, sigY + 30);
    }

    if (contract.borrowerQR) {
        doc.addImage(contract.borrowerQR, 'PNG', sigXRight, sigY + 40, 50, 50);
    }

    doc.save("Saved_Contract_With_Signatures.pdf");
}


function viewContract(index) {
    window.currentDownloadIndex = index; // 👈 This is required
    const contract = userContracts[currentUser.username]
    [index];

    // Function defined INSIDE so it's always in scope
    function downloadThisContract() {
        const { jsPDF } = window.jspdf;
        const contract = userContracts[currentUser.username]
        [window.currentDownloadIndex];
        const doc = new jsPDF();

        const text = contract.content;
        doc.setFont("courier");
        doc.setFontSize(12);

        const marginLeft = 10;
        const marginTop = 10;
        const pageWidth = doc.internal.pageSize.getWidth() - 20;

        doc.text(text, marginLeft, marginTop, { maxWidth: pageWidth });

        const sigXLeft = marginLeft;
        const sigXRight = marginLeft + 100;
        const sigY = marginTop + 180;

        if (contract.lenderSignature && contract.lenderSignature.startsWith("data:image/png")) {
            doc.addImage(contract.lenderSignature, 'PNG', sigXLeft, sigY, 50, 25);
            doc.text("Lender Signature", sigXLeft + 10, sigY + 30);
        }

        if (contract.lenderQR && contract.lenderQR.startsWith("data:image/png")) {
            doc.addImage(contract.lenderQR, 'PNG', sigXLeft, sigY + 40, 50, 50);
        }

        if (contract.borrowerSignature && contract.borrowerSignature.startsWith("data:image/png")) {
            doc.addImage(contract.borrowerSignature, 'PNG', sigXRight, sigY, 50, 25);
            doc.text("Borrower Signature", sigXRight + 10, sigY + 30);
        }

        if (contract.borrowerQR && contract.borrowerQR.startsWith("data:image/png")) {
            doc.addImage(contract.borrowerQR, 'PNG', sigXRight, sigY + 40, 50, 50);
        }

        doc.save("Saved_Contract_With_Signatures.pdf");
    }

    // Inject HTML
    document.body.innerHTML = `
        <div class="top-right-buttons">
            <button class="btn btn-custom print-button" onclick="printContract()"> Print</button>
            <button class="btn btn-custom pdf-button" id="pdfDownloadBtn"> Download PDF</button>
        </div>

        <div class="container">
            <h2>Contract ${index + 1}</h2>
            <pre id="savedContractText" style="white-space: pre-wrap; text-align: left; background: #f1f1f1; padding: 20px; border-radius: 10px;">${contract.content}</pre>

            <div class="signature-section">
                <div class="signature-box">
                    ${contract.lenderSignature ? `<img src="${contract.lenderSignature}" style="max-width: 100%; max-height: 100px;" alt="Lender Signature">` : ""}
                    ${contract.lenderQR ? `<img src="${contract.lenderQR}" style="max-width: 100px; max-height: 100px;" alt="Lender QR Code">` : ""}
                </div>
                <div class="signature-box">
                    ${contract.borrowerSignature ? `<img src="${contract.borrowerSignature}" style="max-width: 100%; max-height: 100px;" alt="Borrower Signature">` : ""}
                    ${contract.borrowerQR ? `<img src="${contract.borrowerQR}" style="max-width: 100px; max-height: 100px;" alt="Borrower QR Code">` : ""}
                </div>
            </div>

            <button class="btn btn-custom" onclick="goToAccountPage()">Back to Account</button>
        </div>
    `;

    document.getElementById("pdfDownloadBtn").addEventListener("click", downloadThisContract);
}


function deleteContract(index) {
    if (!confirm("Are you sure you want to delete this contract?")) return;

    fetch(`http://localhost:3000/contracts/${currentUser.username}/${index}`, {
        method: "DELETE"
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Refresh contracts after deletion
            return fetch(`http://localhost:3000/contracts/${currentUser.username}`);
        }
    })
    .then(res => res.json())
    .then(contracts => {
        userContracts[currentUser.username] = contracts;
        goToAccountPage();
    });
}

function viewArchivedContracts() {
    fetch(`http://localhost:3000/archived/${currentUser.username}`)
        .then(res => res.json())
        .then(contracts => {
            document.body.innerHTML = getNavbarHTML() + `
                <div class="container" style="margin-top: 100px;">
                    <h2>Archived Contracts</h2>
                    ${contracts.length === 0
                        ? "<p>No archived contracts.</p>"
                        : contracts.map((c, i) => `
                            <div style="border: 1px solid black; padding: 20px; margin-bottom: 20px; background-color: #f0f0f0;">
                                <h5>${c.displayName || `Contract ${i + 1}`} - ${c.date}</h5>
                                <button class="btn btn-custom" onclick="viewArchivedContract(${i})">View</button>
                                <button class="btn btn-custom" onclick="deleteArchivedContract(${i})">Delete</button>
                                <button class="btn btn-custom" onclick="printArchivedContract(${i})"> Print</button>
                                <button class="btn btn-custom" onclick="downloadArchivedPDF(${i})"> Save as PDF</button>
                            </div>
                        `).join("")}
                    <button class="btn btn-custom" onclick="goToAccountPage()">Back to Account</button>
                </div>
            `;

            window.archivedContracts = contracts;
        });
}

function printArchivedContract(index) {
    const contract = window.archivedContracts[index];
    const win = window.open("", "_blank");
    win.document.write(`<pre style="font-family: monospace;">${contract.content}</pre>`);
    win.document.close();
    win.print();
}

function downloadArchivedPDF(index) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const contract = window.archivedContracts[index];
    doc.setFont("courier");
    doc.setFontSize(12);

    const marginLeft = 10;
    const marginTop = 10;
    const pageWidth = doc.internal.pageSize.getWidth() - 20;

    doc.text(contract.content, marginLeft, marginTop, { maxWidth: pageWidth });
    doc.save(`Archived_Contract_${index + 1}.pdf`);
}


function viewArchivedContract(index) {
    const contract = window.archivedContracts[index];

    document.body.innerHTML = getNavbarHTML() + `
        <div class="container">
            <h2>Archived Contract</h2>
            <pre style="white-space: pre-wrap; background: #f1f1f1; padding: 20px; border-radius: 10px;">${contract.content}</pre>
            <button class="btn btn-custom" onclick="viewArchivedContracts()">Back</button>
        </div>
    `;
}

function deleteArchivedContract(index) {
    if (!confirm("Delete this archived contract?")) return;

    fetch(`http://localhost:3000/archived/${currentUser.username}/${index}`, {
        method: "DELETE"
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            viewArchivedContracts();
        } else {
            alert("Failed to delete archived contract.");
        }
    });
}

function markPaidInFull(index) {
    if (!confirm("Send Contract to Archived?")) return;

    const contract = userContracts[currentUser.username][index];

    fetch(`http://localhost:3000/archived/${currentUser.username}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(contract)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            return fetch(`http://localhost:3000/contracts/${currentUser.username}/${index}`, {
                method: "DELETE"
            });
        } else {
            throw new Error("Failed to archive");
        }
    })
    .then(() => {
        return fetch(`http://localhost:3000/contracts/${currentUser.username}`);
    })
    .then(res => res.json())
    .then(contracts => {
        userContracts[currentUser.username] = contracts;
        alert("Contract archived.");
        goToAccountPage();
    })
    .catch(err => {
        console.error("Archiving failed:", err);
        alert("Something went wrong.");
    });
}




function startNewContract() {
    loanData = {}; // reset previous contract data
    goToRoleSelection();
}

function logout() {
    currentUser = null;
    goToLandingPage();
}



function getBackButtonHTML() {
     return `<button class="back-button-bottom" onclick="goBack()">Back</button>`;
}

function goToRoleSelection() {
    document.body.innerHTML = getNavbarHTML() + `
        <div class="container">
            <h2>Are you the:</h2>
            <button class="btn btn-custom" onclick="saveRole('Lender')">Lender</button>
            <button class="btn btn-custom" onclick="saveRole('Borrower')">Borrower</button>
        </div>
    `;
}

function goToEmailPage() {
    document.body.innerHTML = getNavbarHTML() + `
        <div class="container">
            <h2>Enter your email:</h2>
            <input type="email" class="form-control" id="email" placeholder="Email" value="${currentUser.email || ''}">
            <button class="btn btn-custom" onclick="saveEmail()">Continue</button>
        </div>
    `;

    // Enable Enter key to continue
    document.addEventListener("keydown", function handler(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            saveEmail();
            document.removeEventListener("keydown", handler);
        }
    });
}


function saveRole(role) {
    loanData.role = role;
    goToEmailPage();
}

function saveEmail() {
    const email = document.getElementById("email").value;

    loanData.email = email;

    if (currentUser) {
        currentUser.email = email;
    }

    goToUserInfoPage();
}



function goToUserInfoPage() {
    document.body.innerHTML = getNavbarHTML() + `
        <div class="container">
            <h2>Enter your information:</h2>
            <input type="text" class="form-control" id="firstName" placeholder="First Name" value="${currentUser.firstName || ''}">
            <input type="text" class="form-control" id="lastName" placeholder="Last Name" value="${currentUser.lastName || ''}">
            <input type="text" id="phone" class="form-control" placeholder="123-456-7890" oninput="formatPhoneNumber(this)" value="${currentUser.phone || ''}">
            <textarea id="address" class="form-control" placeholder="Street Address, City, State, ZIP" rows="3">${currentUser.address || ''}</textarea>
            <button class="btn btn-custom" onclick="saveUserInfo()">Continue</button>
        </div>
    `;

    // Enter key triggers saveUserInfo
    document.addEventListener("keydown", function handler(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            saveUserInfo();
            document.removeEventListener("keydown", handler);
        }
    });
}

function formatPhoneNumber(input) {
    let numbers = input.value.replace(/\D/g, ""); // Remove non-numeric characters

    if (numbers.length > 3 && numbers.length <= 6) {
        input.value = numbers.slice(0, 3) + "-" + numbers.slice(3);
    } else if (numbers.length > 6) {
        input.value = numbers.slice(0, 3) + "-" + numbers.slice(3, 6) + "-" + numbers.slice(6, 10);
    }
}

function saveUserInfo() {
    // Update local currentUser object
    currentUser.firstName = document.getElementById("firstName").value;
    currentUser.lastName = document.getElementById("lastName").value;
    currentUser.phone = document.getElementById("phone").value;
    currentUser.address = document.getElementById("address").value;

    // Save into loanData too
    loanData.firstName = currentUser.firstName;
    loanData.lastName = currentUser.lastName;
    loanData.phone = currentUser.phone;
    loanData.address = currentUser.address;

    // If not a guest, send update to backend
    if (currentUser.username !== "Guest") {
        fetch(`http://localhost:3000/user/update`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentUser)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                //alert("Info updated successfully!");
                goToLoanAmountPage();
            } else {
                alert("Update failed.");
            }
        });
    } else {
        // Skip backend, just move on
        goToLoanAmountPage();
    }
}




function goToLoanAmountPage() {
    document.body.innerHTML = getNavbarHTML() + `
        <div class="container">
            <h2>Enter Loan Amount:</h2>
            <div class="input-group">
                <span>$</span>
                <input type="text" id="loanAmount" class="form-control" placeholder="0.00" oninput="formatLoanAmount(this)">
            </div>
            <button class="btn btn-custom" onclick="saveLoanAmount()">Continue</button>
        </div>
    `;

    // Enter key triggers saveLoanAmount
    document.addEventListener("keydown", function handler(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            saveLoanAmount();
            document.removeEventListener("keydown", handler);
        }
    });
}


function formatLoanAmount(input) {
    let value = input.value.replace(/[^0-9.]/g, ""); // Allow only numbers and a decimal
    if (value.includes(".")) {
    let parts = value.split(".");
    if (parts.length > 2) {
    value = parts[0] + "." + parts[1]; // Keep only one decimal
        }
        input.value = parseFloat(value).toFixed(2); // Auto add two decimals
        } else {
        input.value = value;
        }
        }


        function saveLoanAmount() {
            loanData.loanAmount = document.getElementById("loanAmount").value;
            goToRepaymentSchedulePage();
        }

function goToRepaymentSchedulePage() {
    document.body.innerHTML = getNavbarHTML() + `
    <div class="container">
        <h2>Select Repayment Schedule:</h2>

        <select id="repaymentSchedule" class="form-control" onchange="handleScheduleChange()">
            <option value="">-- Select --</option>
            <option value="One-Time">One-Time</option>
            <option value="Weekly">Weekly</option>
            <option value="Bi-Weekly">Bi-Weekly</option>
            <option value="Monthly">Monthly</option>
        </select>

        <div id="paymentCountContainer" style="display: none; margin-top: 20px;">
            <label for="paymentCount">Number of Payments:</label>
            <select id="paymentCount" class="form-control" onchange="handlePaymentCountChange()" style="margin-top: 10px;">
                <option value="">-- Select --</option>
                ${[...Array(24)].map((_, i) => `<option value="${i + 1}">${i + 1}</option>`).join("")}
            </select>
        </div>

        <div id="interestSection" style="display: none; margin-top: 20px;">
            <p style="margin-bottom: 10px;">Would you like to include interest?</p>
            <div class="btn-group" style="gap: 10px;">
                <button class="btn btn-custom" onclick="selectInterestType('Simple Interest')">Simple Interest</button>
                <button class="btn btn-custom" id="amortizedBtn" style="display: none;" onclick="selectInterestType('Amortized Monthly Payments')">Amortized Monthly Payments</button>
            </div>

            <div id="interestRateSection" style="display: none; margin-top: 15px;">
                <label for="interestRate" style="font-weight: bold;">Interest Rate (%):</label>
                <select id="interestRate" class="form-control" onchange="updateEstimatedPayment()" style="margin-top: 10px;">
                    <option value="">Select</option>
                    <option value="2">2%</option>
                    <option value="5">5%</option>
                    <option value="8">8%</option>
                    <option value="10">10%</option>
                    <option value="12">12%</option>
                    <option value="15">15%</option>
                </select>
            </div>

            <p id="estimatedPaymentText" style="margin-top: 20px; font-weight: bold;"></p>

            <div id="interestButtonsContainer" style="margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
    <button class="btn btn-custom" onclick="skipInterest()">Skip</button>
    <button id="continueAfterInterestBtn" class="btn btn-custom" style="display: none;" onclick="saveRepaymentSchedule()">Continue</button>
</div>

        </div>
    </div>
    `;

    document.addEventListener("keydown", function handler(e) {
        if (e.key === "Enter") {
            const btn = document.getElementById("continueAfterInterestBtn");
            if (btn && btn.style.display !== "none") {
                e.preventDefault();
                saveRepaymentSchedule();
                document.removeEventListener("keydown", handler);
            }
        }
    });
}


function handlePaymentCountChange() {
    const count = document.getElementById("paymentCount").value;
    if (count) {
        loanData.paymentCount = parseInt(count);
        document.getElementById("interestSection").style.display = "block";
    }
}

function selectInterestType(type) {
    loanData.interestType = type;

    // Show interest rate dropdown
    document.getElementById("interestRateSection").style.display = "block";
    document.getElementById("continueAfterInterestBtn").style.display = "none";
    document.getElementById("estimatedPaymentText").innerText = "";

    // Hide the "Skip" button
    const skipBtn = document.querySelector("#interestButtonsContainer button[onclick='skipInterest()']");
    if (skipBtn) skipBtn.style.display = "none";

    // Create "Don't Add Interest" button if not already there
    if (!document.getElementById("cancelInterestBtn")) {
        const cancelBtn = document.createElement("button");
        cancelBtn.id = "cancelInterestBtn";
        cancelBtn.className = "btn btn-custom";
        cancelBtn.textContent = "Don't Add Interest";

        cancelBtn.onclick = () => {
            loanData.interestType = "None";
            loanData.interestRate = null;

            document.getElementById("interestRateSection").style.display = "none";
            document.getElementById("estimatedPaymentText").innerText = "";

            cancelBtn.remove();

            if (skipBtn) skipBtn.style.display = "inline-block";
            document.getElementById("continueAfterInterestBtn").style.display = "none";
        };

        const btnContainer = document.getElementById("interestButtonsContainer");
        if (btnContainer) btnContainer.appendChild(cancelBtn);
    }

    // Show continue button after interest selected
    const continueBtn = document.getElementById("continueAfterInterestBtn");
    if (continueBtn) continueBtn.style.display = "inline-block";
}







function cancelInterest() {
    loanData.interestType = "None";
    loanData.interestRate = null;

    // Hide interest inputs
    document.getElementById("interestRateSection").style.display = "none";
    document.getElementById("estimatedPaymentText").innerText = "";

    // Remove cancel button
    const cancelBtn = document.getElementById("cancelInterestBtn");
    if (cancelBtn) cancelBtn.remove();

    // Show the continue button to proceed without interest
    document.getElementById("continueAfterInterestBtn").style.display = "inline-block";
}






function updateEstimatedPayment() {
    const rate = parseFloat(document.getElementById("interestRate").value);
    if (!rate || !loanData.loanAmount || !loanData.paymentCount) return;

    loanData.interestRate = rate;

    const principal = parseFloat(loanData.loanAmount);
    const numPayments = loanData.paymentCount;
    let monthlyPayment = 0;

    if (loanData.interestType === "Simple Interest") {
        const totalInterest = (principal * (rate / 100));
        const totalAmount = principal + totalInterest;
        monthlyPayment = totalAmount / numPayments;
    } else if (loanData.interestType === "Amortized Monthly Payments") {
        const monthlyRate = rate / 100 / 12;
        monthlyPayment = (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -numPayments));
    }

    document.getElementById("estimatedPaymentText").innerText =
        `Estimated Payment: $${monthlyPayment.toFixed(2)} (${loanData.paymentCount} payments)`;

    document.getElementById("continueAfterInterestBtn").style.display = "inline-block";
}

function skipInterest() {
    loanData.interestType = "None";
    loanData.interestRate = null;

    document.getElementById("estimatedPaymentText").innerText = "";
    document.getElementById("interestRateSection").style.display = "none";

    const cancelBtn = document.getElementById("cancelInterestBtn");
    if (cancelBtn) cancelBtn.remove();

    const continueBtn = document.getElementById("continueAfterInterestBtn");
    if (continueBtn) continueBtn.style.display = "inline-block";
}







function toggleInterestOption() {
    const schedule = document.getElementById("repaymentSchedule").value;

    // Only show amortized on the interest selection page if "Monthly" is selected
    loanData.showAmortizedOption = schedule === "Monthly";
}


        function saveRepaymentSchedule() {
            loanData.repaymentSchedule = document.getElementById("repaymentSchedule").value;
            goToStartDatePage();
        }

   
function checkScheduleAndCountSelected() {
    const count = document.getElementById("paymentCount").value;
    document.getElementById("repaymentContinueBtn").style.display = count ? "block" : "none";
    updatePaymentPreview();
}

function handleScheduleChange() {
    const schedule = document.getElementById("repaymentSchedule").value;
    const countContainer = document.getElementById("paymentCountContainer");
    const interestSection = document.getElementById("interestSection");
    const amortizedBtn = document.getElementById("amortizedBtn");

    loanData.repaymentSchedule = schedule;

    if (schedule === "One-Time") {
        loanData.paymentCount = 1;
        countContainer.style.display = "none";
        interestSection.style.display = "block";
        amortizedBtn.style.display = "none";
        document.getElementById("continueAfterInterestBtn").style.display = "none";
    } else if (schedule) {
        countContainer.style.display = "block";
        interestSection.style.display = "none";
        amortizedBtn.style.display = schedule === "Monthly" ? "inline-block" : "none";
    } else {
        countContainer.style.display = "none";
        interestSection.style.display = "none";
        amortizedBtn.style.display = "none";
    }
}

function updatePaymentPreview() {
    const schedule = document.getElementById("repaymentSchedule").value;
    const count = parseInt(document.getElementById("paymentCount")?.value || "0");
    const preview = document.getElementById("paymentPreview");

    if (!schedule || schedule === "One-Time" || !count || isNaN(count)) {
        preview.innerText = "";
        return;
    }

    const amount = parseFloat(loanData.loanAmount || "0");
    const rate = parseFloat(loanData.interestRate || "0");
    const hasInterest = loanData.interestType && loanData.interestType !== "None";

    let totalWithInterest = amount;

    if (hasInterest) {
        const interestTotal = loanData.interestType === "Amortized Monthly Payments"
            ? (amount * rate / 100)  // simple approx for preview
            : (amount * rate / 100);
        totalWithInterest += interestTotal;
    }

    const payment = (totalWithInterest / count).toFixed(2);
    preview.innerText = `Estimated Payment: $${payment} x ${count}`;
}


function saveRepaymentSchedule() {
    loanData.repaymentSchedule = document.getElementById("repaymentSchedule").value;
    loanData.paymentCount = loanData.repaymentSchedule === "One-Time"
        ? 1
        : parseInt(document.getElementById("paymentCount").value);

    goToStartDatePage();
}

function goToStartDatePage() {
    document.body.innerHTML = getNavbarHTML() + `
        <div class="container">
            <h2>Enter Start Date:</h2>
            <input type="date" id="startDate">
            <button class="btn btn-custom" onclick="saveStartDate()">Continue</button>
        </div>
    `;

    // Enter key triggers saveStartDate
    document.addEventListener("keydown", function handler(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            saveStartDate();
            document.removeEventListener("keydown", handler);
        }
    });
}

function saveStartDate() {
    loanData.startDate = document.getElementById("startDate").value;
    goToBorrowerInfo();
}

function goToBorrowerInfo() {
    document.body.innerHTML = getNavbarHTML() + `
        <div class="container">
            <h2>Enter your Borrower's information:</h2>
            <input type="text" class="form-control" id="borrowerEmail" placeholder="Email">
            <input type="text" class="form-control" id="borrowerFirstName" placeholder="First Name">
            <input type="text" class="form-control" id="borrowerLastName" placeholder="Last Name">
            <input type="tel" class="form-control" id="borrowerPhone" placeholder="Phone">
            <input type="text" class="form-control" id="borrowerAddress" placeholder="Address">
            <button class="btn btn-custom" onclick="saveBorrowerInfo()">Continue</button>
        </div>
    `;

    // Enter key triggers saveBorrowerInfo
    document.addEventListener("keydown", function handler(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            saveBorrowerInfo();
            document.removeEventListener("keydown", handler);
        }
    });
}

function saveBorrowerInfo() {
    loanData.borrowerEmail = document.getElementById("borrowerEmail").value;
    loanData.borrowerFirstName = document.getElementById("borrowerFirstName").value;
    loanData.borrowerLastName = document.getElementById("borrowerLastName").value;
    loanData.borrowerPhone = document.getElementById("borrowerPhone").value;
    loanData.borrowerAddress = document.getElementById("borrowerAddress").value;
    
    goToGenerateAgreement();
}

        

function toggleSubmitButton() {
    const rate = document.getElementById("interestRate").value;
    document.getElementById("interestSubmitBtn").style.display = rate ? "inline-block" : "none";
}

function submitInterest() {
    const selectedRate = document.getElementById("interestRate").value;
    if (!selectedRate) {
        alert("Please select an interest rate.");
        return;
    }
    loanData.interestRate = selectedRate;
    goToGenerateAgreement();
}



function showInterestEstimate() {
    const rate = parseFloat(document.getElementById("interestRate")?.value || "0");
    const estimateDiv = document.getElementById("interestEstimate");

    if (!rate || isNaN(rate)) {
        estimateDiv.innerText = "";
        return;
    }

    const amount = parseFloat(loanData.loanAmount || "0");
    const count = parseInt(loanData.paymentCount || "1");

    let total = amount;

    if (loanData.interestType === "Amortized Monthly Payments") {
        const monthlyRate = rate / 100 / 12;
        const amortizedPayment = (amount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -count));
        estimateDiv.innerText = `Est. Monthly Payment: $${amortizedPayment.toFixed(2)} x ${count}`;
    } else if (loanData.interestType === "Simple Interest") {
        const totalInterest = amount * (rate / 100);
        total += totalInterest;
        const perPayment = total / count;
        estimateDiv.innerText = `Est. Payment: $${perPayment.toFixed(2)} x ${count}`;
    } else {
        estimateDiv.innerText = "";
    }
}

function goToGenerateAgreement() {
    document.body.innerHTML = getNavbarHTML() + `
        <div class="container">
            <h2>Click to view your loan agreement</h2>
            <button class="btn btn-custom" onclick="generateLoanContract()">View Agreement</button>
        </div>
    `;
}

function generateLoanContract() {
    let lenderName, lenderAddress, lenderEmail, lenderPhone;
    let borrowerName, borrowerAddress, borrowerEmail, borrowerPhone;

    if (loanData.role === "Lender") {
        lenderName = `${loanData.firstName || '________________'} ${loanData.lastName || '________________'}`;
        lenderAddress = loanData.address || '________________';
        lenderEmail = loanData.email || '________________';
        lenderPhone = loanData.phone || '________________';

        borrowerName = `${loanData.borrowerFirstName || '________________'} ${loanData.borrowerLastName || '________________'}`;
        borrowerAddress = loanData.borrowerAddress || '________________';
        borrowerEmail = loanData.borrowerEmail || '________________';
        borrowerPhone = loanData.borrowerPhone || '________________';
    } else {
        borrowerName = `${loanData.firstName || '________________'} ${loanData.lastName || '________________'}`;
        borrowerAddress = loanData.address || '________________';
        borrowerEmail = loanData.email || '________________';
        borrowerPhone = loanData.phone || '________________';

        lenderName = `${loanData.borrowerFirstName || '________________'} ${loanData.borrowerLastName || '________________'}`;
        lenderAddress = loanData.borrowerAddress || '________________';
        lenderEmail = loanData.borrowerEmail || '________________';
        lenderPhone = loanData.borrowerPhone || '________________';
    }

    const principal = parseFloat(loanData.loanAmount || 0);
    const payments = parseInt(loanData.paymentCount || 1);
    const interestRate = parseFloat(loanData.interestRate || 0) / 100;

    let totalInterest = 0;
    let totalRepayment = principal;
    let monthlyPayment = null;
    let principalPerPayment = (principal / payments);
    let interestPerPayment = 0;

    if (loanData.interestType === "Simple Interest") {
        totalInterest = principal * interestRate;
        totalRepayment = principal + totalInterest;
        interestPerPayment = totalInterest / payments;
        monthlyPayment = principalPerPayment + interestPerPayment;
    } else if (loanData.interestType === "Amortized Monthly Payments") {
        if (interestRate > 0 && payments > 0) {
            const r = interestRate;
            monthlyPayment = (principal * r) / (1 - Math.pow(1 + r, -payments));
            totalRepayment = monthlyPayment * payments;
            totalInterest = totalRepayment - principal;
            interestPerPayment = totalInterest / payments;
            principalPerPayment = monthlyPayment - interestPerPayment;
        }
    } else {
        monthlyPayment = principalPerPayment;
    }

    const interestSummary = loanData.interestType && loanData.interestType !== "None"
        ? `- ${loanData.interestType} at ${loanData.interestRate}% | Total: $${totalRepayment.toFixed(2)} over ${payments} payments of $${monthlyPayment.toFixed(2)}`
        : `- No interest | Total: $${principal.toFixed(2)} | One payment of $${monthlyPayment.toFixed(2)}`;

    const contractText = `

This Loan Agreement ("Agreement") is made and entered into on ${new Date().toLocaleDateString()} between:

Lender: ${lenderName}
Address: ${lenderAddress}
Email: ${lenderEmail}
Phone: ${lenderPhone}

and

Borrower: ${borrowerName}
Address: ${borrowerAddress}
Email: ${borrowerEmail}
Phone: ${borrowerPhone}

LOAN TERMS

- Principal Amount: $${principal.toFixed(2)}
- Repayment Schedule: ${loanData.repaymentSchedule || '__________'}
- Start Date: ${loanData.startDate || '__________'}
${interestSummary}
- Prepayment: Borrower may prepay without penalty.

DEFAULT AND LEGAL ACTION

If the Borrower fails to make payments as agreed, the Lender reserves the right to pursue legal action to recover the outstanding amount.

SIGNATURES
`;

    document.body.innerHTML = `
        <div class="top-right-buttons" style="position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
            <button class="btn btn-custom" style="width: 160px;" onclick="saveAsPDF()">Download PDF</button>
            <button class="btn btn-custom" style="width: 160px;" onclick="printContract()">Print</button>
            <button class="btn btn-custom" style="width: 160px;" onclick="saveContractToAccount()">Save to Account</button>
        </div>

        <div class="bottom-nav">
            <button class="btn btn-custom back-button-bottom" onclick="goToGenerateAgreement()">Back</button>
        </div>

        <div class="container">
            <h2>Loan Agreement</h2>
            <pre id="contractText"></pre>

            <div class="signature-section">
                <div class="signature-box">
                    <canvas id="lenderSignaturePad" class="signature-canvas"></canvas>
                    <img id="lenderSignatureImage" class="signature-img" src="" alt="Lender Signature">
                    <button class="btn btn-custom signature-button" onclick="openSignaturePad('lender')">Lender Signature</button>
                    <button class="btn btn-custom signature-button clear-btn" id="lenderClear" onclick="clearSignature('lender')">Clear</button>
                    <button class="btn btn-custom signature-button save-btn" id="lenderSave" onclick="saveSignature('lender')">Save</button>
                    <input type="file" id="lenderQRInput" class="qr-upload" accept="image/*" onchange="uploadQRCode('lender')" style="display: none;">
                    <button class="btn btn-custom qr-upload" id="lenderQRUpload" onclick="document.getElementById('lenderQRInput').click();" style="display: none;">Upload Payment QR Code</button>
                    <img id="lenderQRCodeImage" class="qr-image" src="" alt="Lender QR Code" style="display: none;">
                </div>

                <div class="signature-box">
                    <canvas id="borrowerSignaturePad" class="signature-canvas"></canvas>
                    <img id="borrowerSignatureImage" class="signature-img" src="" alt="Borrower Signature">
                    <button class="btn btn-custom signature-button" onclick="openSignaturePad('borrower')">Borrower Signature</button>
                    <button class="btn btn-custom signature-button clear-btn" id="borrowerClear" onclick="clearSignature('borrower')">Clear</button>
                    <button class="btn btn-custom signature-button save-btn" id="borrowerSave" onclick="saveSignature('borrower')">Save</button>
                    <input type="file" id="borrowerQRInput" class="qr-upload" accept="image/*" onchange="uploadQRCode('borrower')" style="display: none;">
                    <button class="btn btn-custom qr-upload" id="borrowerQRUpload" onclick="document.getElementById('borrowerQRInput').click();" style="display: none;">Upload Payment QR Code</button>
                    <img id="borrowerQRCodeImage" class="qr-image" src="" alt="Borrower QR Code" style="display: none;">
                </div>
            </div>
        </div>
    `;

    document.getElementById("contractText").innerText = contractText;
}

function openSignaturePad(role) {
    let canvas = document.getElementById(`${role}SignaturePad`);
    let clearBtn = document.getElementById(`${role}Clear`);
    let saveBtn = document.getElementById(`${role}Save`);

    canvas.style.display = "block";
    clearBtn.style.display = "inline-block";
    saveBtn.style.display = "inline-block";

    canvas.width = canvas.clientWidth;
    canvas.height = 150;

    if (!signaturePads[role]) {
        signaturePads[role] = new SignaturePad(canvas, {
            backgroundColor: 'white',
            penColor: 'black'
        });
    }
}

function clearSignature(role) {
    if (signaturePads[role]) {
        signaturePads[role].clear();
    }
}

function saveSignature(role) {
    if (!signaturePads[role] || signaturePads[role].isEmpty()) {
        alert('Please provide a signature.');
        return;
    }

    let signatureData = signaturePads[role].toDataURL();
    let img = document.getElementById(`${role}SignatureImage`);
    let canvas = document.getElementById(`${role}SignaturePad`);
    let signatureButton = document.querySelector(`button[onclick="openSignaturePad('${role}')"]`);

    img.src = signatureData;
    img.style.display = "block";
    canvas.style.display = "none";

    document.getElementById(`${role}Clear`).style.display = "none";
    document.getElementById(`${role}Save`).style.display = "none";

    signatureButton.disabled = true;
    signatureButton.style.opacity = "0.5";
    signatureButton.style.cursor = "not-allowed";

    document.getElementById(`${role}QRUpload`).style.display = "block";
}


    let signatureData = signaturePads[role].toDataURL();
    let img = document.getElementById(`${role}SignatureImage`);
    let canvas = document.getElementById(`${role}SignaturePad`);
    let signatureButton = document.querySelector(`button[onclick="openSignaturePad('${role}')"]`);

    img.src = signatureData;
    img.style.display = "block";
    canvas.style.display = "none";

    // Hide the clear and save buttons after saving
    document.getElementById(`${role}Clear`).style.display = "none";
    document.getElementById(`${role}Save`).style.display = "none";

    // Disable the signature button to prevent re-signing
    signatureButton.disabled = true;
    signatureButton.style.opacity = "0.5";
    signatureButton.style.cursor = "not-allowed";

    // Show the QR Code upload button after signature is saved
    document.getElementById(`${role}QRUpload`).style.display = "block";



function uploadQRCode(role) {
    let input = document.getElementById(`${role}QRInput`);
    let qrImage = document.getElementById(`${role}QRCodeImage`);
    let uploadButton = document.getElementById(`${role}QRUpload`);
    let file = input.files[0];

    if (file) {
        let reader = new FileReader();
        reader.onload = function (e) {
            qrImage.src = e.target.result;
            qrImage.style.display = "block";
            uploadButton.style.display = "none"; // Hide upload button after successful upload
        };
        reader.readAsDataURL(file);
    }
}



function saveAsPDF() {
    const { jsPDF } = window.jspdf;
    let doc = new jsPDF();

    let contractText = document.getElementById("contractText").innerText;
    doc.setFont("courier");
    doc.setFontSize(12);

    let marginLeft = 10;
    let marginTop = 10;
    let pageWidth = doc.internal.pageSize.getWidth() - 20;

    doc.text(contractText, marginLeft, marginTop, { maxWidth: pageWidth });

    let sigXLeft = marginLeft;
    let sigXRight = marginLeft + 100;
    let sigY = marginTop + 180;

    let lenderSig = document.getElementById("lenderSignatureImage");
    if (lenderSig && lenderSig.src && lenderSig.src.startsWith("data:image/png")) {
        doc.addImage(lenderSig.src, 'PNG', sigXLeft, sigY, 50, 25);
        doc.text("Lender Signature", sigXLeft + 10, sigY + 30);
    }

    let lenderQR = document.getElementById("lenderQRCodeImage");
    if (lenderQR && lenderQR.src && lenderQR.src.startsWith("data:image/png")) {
        doc.addImage(lenderQR.src, 'PNG', sigXLeft, sigY + 40, 50, 50);
    }

    let borrowerSig = document.getElementById("borrowerSignatureImage");
    if (borrowerSig && borrowerSig.src && borrowerSig.src.startsWith("data:image/png")) {
        doc.addImage(borrowerSig.src, 'PNG', sigXRight, sigY, 50, 25);
        doc.text("Borrower Signature", sigXRight + 10, sigY + 30);
    }

    let borrowerQR = document.getElementById("borrowerQRCodeImage");
    if (borrowerQR && borrowerQR.src && borrowerQR.src.startsWith("data:image/png")) {
        doc.addImage(borrowerQR.src, 'PNG', sigXRight, sigY + 40, 50, 50);
    }

    doc.save("Loan_Agreement.pdf");
}

function printContract() {
    window.print();
}

function saveTextAsPDF() {
    const { jsPDF } = window.jspdf;
    let doc = new jsPDF();

    const text = document.getElementById("savedContractText").innerText;
    doc.setFont("courier");
    doc.setFontSize(12);

    let marginLeft = 10;
    let marginTop = 10;
    let pageWidth = doc.internal.pageSize.getWidth() - 20;

    doc.text(text, marginLeft, marginTop, { maxWidth: pageWidth });
    doc.save("Saved_Contract.pdf");
}

function togglePaymentStatus(contractIndex, paymentIndex) {
    const contracts = userContracts[currentUser.username] || [];
    const contract = contracts[contractIndex];
    const payment = contract.payments[paymentIndex];

    payment.paid = !payment.paid;

    fetch(`http://localhost:3000/contracts/${currentUser.username}/${contractIndex}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(contract)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            goToAccountPage();
        } else {
            alert("Failed to update payment status.");
        }
    })
    .catch(err => {
        console.error("Error updating payment:", err);
        alert("Error saving payment status.");
    });
}


    </script>
</head>
<body>
    
    <div class="container">
        <h1>Agreed.</h1>
        <p>Person to person loans made simple</p>
        <button class="btn btn-custom" onclick="goToRoleSelection()">Continue</button>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
    goToLandingPage();
});

function generatePaymentSchedule(startDate, schedule, count) {
    const payments = [];
    let currentDate = new Date(startDate);

    for (let i = 0; i < count; i++) {
        payments.push({ date: currentDate.toISOString().split('T')[0], received: false });

        if (schedule === "Weekly") {
            currentDate.setDate(currentDate.getDate() + 7);
        } else if (schedule === "Bi-Weekly") {
            currentDate.setDate(currentDate.getDate() + 14);
        } else if (schedule === "Monthly") {
            currentDate.setMonth(currentDate.getMonth() + 1);
        }
    }

    return payments;
}


function saveContractToAccount() {
    const contractText = document.getElementById("contractText").innerText;

    if (!currentUser) {
        alert("You must be logged in to save the contract.");
        return;
    }

    const isLender = loanData.role === "Lender";
    const otherPersonName = isLender
        ? `${loanData.borrowerFirstName || 'Unknown'} ${loanData.borrowerLastName || ''}`
        : `${loanData.firstName || 'Unknown'} ${loanData.lastName || ''}`;

    const paymentCount = parseInt(loanData.paymentCount) || 1;
    const principal = parseFloat(loanData.loanAmount || 0);
    const rate = parseFloat(loanData.interestRate || 0) / 100;
    const interestType = loanData.interestType || "None";

    let totalRepayment = principal;
    let monthlyAmount = principal / paymentCount;

    if (interestType === "Simple Interest") {
        const totalInterest = principal * rate;
        totalRepayment = principal + totalInterest;
        monthlyAmount = totalRepayment / paymentCount;
    } else if (interestType === "Amortized Monthly Payments") {
        if (rate > 0 && paymentCount > 0) {
            monthlyAmount = (principal * rate) / (1 - Math.pow(1 + rate, -paymentCount));
            totalRepayment = monthlyAmount * paymentCount;
        }
    }

    const displayName = `${otherPersonName.trim()} ($${totalRepayment.toFixed(2)})`;

    const payments = [];
    const baseDate = new Date(loanData.startDate);
    const schedule = loanData.repaymentSchedule;

    for (let i = 0; i < paymentCount; i++) {
        const dueDate = new Date(baseDate);
        if (schedule === "Weekly") {
            dueDate.setDate(baseDate.getDate() + i * 7);
        } else if (schedule === "Bi-Weekly") {
            dueDate.setDate(baseDate.getDate() + i * 14);
        } else if (schedule === "Monthly") {
            dueDate.setMonth(baseDate.getMonth() + i);
        }

        payments.push({
            dueDate: dueDate.toISOString().split("T")[0],
            amount: parseFloat(monthlyAmount.toFixed(2)), // ✅ Correct per-payment amount including interest
            paid: false
        });
    }

    const newContract = {
        date: new Date().toLocaleString(),
        displayName,
        content: contractText,
        startDate: loanData.startDate,
        paymentCount,
        repaymentSchedule: schedule,
        loanAmount: principal,
        interestRate: loanData.interestRate,
        interestType,
        payments,
        lenderSignature: document.getElementById("lenderSignatureImage")?.src || null,
        borrowerSignature: document.getElementById("borrowerSignatureImage")?.src || null,
        lenderQR: document.getElementById("lenderQRCodeImage")?.src || null,
        borrowerQR: document.getElementById("borrowerQRCodeImage")?.src || null
    };

    fetch(`http://localhost:3000/contracts/${currentUser.username}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newContract)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            return fetch(`http://localhost:3000/contracts/${currentUser.username}`);
        }
    })
    .then(res => res.json())
    .then(contracts => {
        userContracts[currentUser.username] = contracts;
        alert("Contract saved to your account!");
        goToAccountPage();
    })
    .catch(err => {
        console.error("Failed to save contract:", err);
        alert("There was a problem saving your contract.");
    });
}


function togglePaymentReceived(checkbox) {
    const contractIndex = parseInt(checkbox.dataset.contract);
    const paymentIndex = parseInt(checkbox.dataset.payment);

    const contract = userContracts[currentUser.username][contractIndex];
    if (!contract || !contract.payments || !contract.payments[paymentIndex]) return;

    // Update payment status
    contract.payments[paymentIndex].received = checkbox.checked;

    // Save updated contract to backend
    fetch(`http://localhost:3000/contracts/${currentUser.username}/${contractIndex}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(contract)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Refresh UI to show updated progress bar
            goToAccountPage();
        } else {
            alert("Failed to update payment status.");
        }
    })
    .catch(err => {
        console.error("Error updating payment:", err);
        alert("Error saving payment status.");
    });
}



function toggleCard(index) {
    const body = document.getElementById(`card-body-${index}`);
    body.style.display = (body.style.display === "block") ? "none" : "block";
}

    </script>
    
 
</body>
</html>
   
    
</body>
</html>

